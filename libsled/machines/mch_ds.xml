<icsxml>
  <header><![CDATA[
struct mch_sdo_t;
struct intf_t;
  ]]></header>
  
  <source><![CDATA[
  #define OB_CONTROL_WORD 0x0000
void mch_sdo_queue_write(mch_sdo_t *sdo, uint16_t index, uint8_t subindex, uint8_t length, uint32_t value);
void mch_sdo_queue_read(mch_sdo_t *sdo, uint16_t index, uint8_t subindex);

void mch_ds_send_control_word(mch_ds_t *machine, uint16_t control_word)
{
  mch_sdo_queue_write(machine->mch_sdo, OB_CONTROL_WORD, 0x00, control_word, 0x02);
}    
  ]]></source>
  
  <datamodel>
    <data id="interface" type="intf_t *" />
    <data id="mch_sdo" type="mch_sdo_t *" />
  </datamodel>

  <callbacks>
    <callback id="operation_enabled" />
    <callback id="operation_disabled" />
  </callbacks>
    
  <state id="DS" initial="Disabled">  
    <state id="Disabled">
        <transition event="EV_DS_NET_OPERATIONAL" target="Enabled" type="internal" />      
    </state>
    
    <state id="Enabled" initial="Unknown">
      <transition event="EV_DS_NET_INOPERATIONAL" target="Disabled" type="internal" />
      <transition event="EV_DS_FAULT_REACTION_ACTIVE" target="Fault" type="internal" />
      <transition event="EV_DS_FAULT" target="Clearing_fault" type="internal" />
    
      <state id="Unknown">
        <transition event="EV_DS_NOT_READY_TO_SWITCH_ON" target="Switch_on_disabled" type="internal" />
        <transition event="EV_DS_READY_TO_SWITCH_ON" target="Ready_to_switch_on" type="internal" />
        <onentry><![CDATA[mch_ds_send_control_word(machine, 0x06); // Shutdown]]></onentry>
      </state>

      <state id="Fault">
        <transition event="EV_DS_FAULT" target="Clearing_Fault" />
      </state>
    
      <state id="Clearing_Fault">
        <transition event="EV_DS_NOT_READY_TO_SWITCH_ON" target="Switch_on_disabled" type="internal" />
        <transition event="EV_DS_READY_TO_SWITCH_ON" target="Ready_to_switch_on" type="internal" />
        <transition event="EV_DS_SWITCHED_ON" target="Switched_on" type="internal" />
        <onentry><![CDATA[mch_sdo_queue_read(machine->mch_sdo, 0x3518, 0x01);]]></onentry>
      </state>
    
      <state id="Switch_on_disabled">
        <transition event="EV_DS_VOLTAGE_ENABLED" target="Prepare_switch_on" type="internal" />
      </state>
    
      <state id="Prepare_switch_on">
        <transition event="EV_DS_READY_TO_SWITCH_ON" target="Ready_to_switch_on" type="internal" />
        <onentry><![CDATA[mch_ds_send_control_word(machine, 0x06); // Shutdown]]></onentry>
      </state>
    
      <state id="Ready_to_switch_on">
        <transition event="EV_DS_VOLTAGE_ENABLED" target="Switch_on" type="internal" />
      </state>

      <state id="Switch_on">
        <transition event="EV_DS_SWITCHED_ON" target="Switched_on" type="internal" />
        <transition event="EV_DS_VOLTAGE_DISABLED" target="Shutdown" type="internal" />
        <onentry><![CDATA[mch_ds_send_control_word(machine, 0x07); // Switch on]]></onentry>
      </state>

      <state id="Shutdown">
        <transition event="EV_DS_NOT_READY_TO_SWITCH_ON" target="Switch_on_disabled" type="internal" />
        <transition event="EV_DS_READY_TO_SWITCH_ON" target="Ready_to_switch_on" type="internal" />
        <onentry><![CDATA[mch_ds_send_control_word(machine, 0x06); // Shutdown]]></onentry>
      </state>

      <state id="Switched_on">
        <transition event="EV_DS_VOLTAGE_ENABLED" target="Enable_operation" type="internal" />
        <transition event="EV_DS_VOLTAGE_DISABLED" target="Shutdown" type="internal" />
      </state>

      <state id="Disable_operation">
        <transition event="EV_DS_SWITCHED_ON" target="Switched_on" type="internal" />
        <onentry><![CDATA[mch_ds_send_control_word(machine, 0x07); // Disable operation]]></onentry>
      </state>

      <state id="Enable_operation">
        <transition event="EV_DS_OPERATION_ENABLED" target="Operation_enabled" type="internal" />
        <onentry><![CDATA[mch_ds_send_control_word(machine, 0x0F); // Enable operation]]></onentry>
      </state>

      <state id="Operation_enabled">
        <transition event="EV_DS_VOLTAGE_DISABLED" target="Disable_operation" type="internal" />
        <onentry><![CDATA[if(machine->operation_enabled_handler) machine->operation_enabled_handler(machine, machine->payload);]]></onentry>
        <onexit><![CDATA[if(machine->operation_disabled_handler) machine->operation_disabled_handler(machine, machine->payload);]]></onexit>
      </state>
    </state>
  </state>
</icsxml>
